<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yale Dining — Compare Menus</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f7f9fb;color:#0f172a}
  header{background:#00356b;color:#fff;padding:1rem;text-align:center}
  main{max-width:1100px;margin:1.5rem auto;padding:0 1rem}
  .controls{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;justify-content:center;margin-bottom:1rem}
  select,button,input{padding:.5rem .75rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1rem}
  button{cursor:pointer;background:#fff}
  button.active{background:#00356b;color:#fff;border-color:#00356b}
  .btn-danger{background:#ef4444;color:#fff;border:none}
  .table-wrap{background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.06);overflow:auto}
  table{width:100%;min-width:700px;border-collapse:collapse}
  th,td{padding:.75rem 1rem;border:1px solid #e6eef6;text-align:left;vertical-align:top}
  th{background:#00356b;color:#fff;position:sticky;top:0}
  tr:nth-child(even){background:#fbfdff}
  .empty{text-align:center;color:#6b7280;padding:1rem}
  ul.dish-list{list-style:none;margin:0;padding:0}
  ul.dish-list li{padding:.35rem 0;border-bottom:1px dashed #eee}
  .tags{font-size:.85rem;color:#6b7280;margin-top:.25rem}
  @media(max-width:600px){table{display:block;overflow-x:auto;white-space:nowrap}}
</style>
</head>
<body>
  <header>
    <h1>Yale Dining — Compare Menus</h1>
    <div style="opacity:.9;font-size:.95rem">Choose halls, meal, and dietary filters to compare menus side-by-side</div>
  </header>

  <main>
    <div class="controls">
      <label for="hallSelect">Dining Halls:</label>
      <select id="hallSelect" multiple size="4" style="min-width:220px">
        <option disabled>Loading halls...</option>
      </select>
      <button id="selectAllBtn">Select All</button>

      <label for="mealSelect">Meal:</label>
      <select id="mealSelect">
        <option value="breakfast">Breakfast</option>
        <option value="lunch" selected>Lunch</option>
        <option value="dinner">Dinner</option>
      </select>

      <div id="dietFilters" style="display:flex;gap:.5rem;align-items:center">
        <button class="diet-btn" data-diet="vegan">Vegan</button>
        <button class="diet-btn" data-diet="vegetarian">Vegetarian</button>
        <button class="diet-btn" data-diet="gluten-free">Gluten-Free</button>
      </div>

      <button id="clearFilters" class="btn-danger">Clear</button>
    </div>

    <div id="tableContainer" class="table-wrap" style="display:none">
      <table id="menuTable" aria-describedby="desc">
        <thead><tr id="headerRow"></tr></thead>
        <tbody id="bodyRows"></tbody>
      </table>
    </div>

    <div id="noResults" class="empty" style="display:none">No dishes match your filters.</div>
  </main>

<script>
/* CONFIG */
const API = 'http://localhost:4000/api/dining/all?days=1';

/* State */
let halls = [];            // list of hall objects from API
let hallBySlug = {};       // slug -> hall
let selectedSlugs = [];    // selected halls (slugs)
let selectedMeal = 'lunch';
let activeDiets = new Set();

/* Heuristic keywords for diet matching (lowercase substrings) */
const dietKeywords = {
  'vegan': ['vegan', 'tofu', 'tempeh', 'plant-based', 'vegan '],
  'vegetarian': ['vegetarian', 'veggie', 'egg', 'cheese', 'paneer', 'vegetable'],
  'gluten-free': ['gluten-free', 'gluten free', 'gf', 'gluten-free', 'gluten-free ']
  // removed 'halal'
};

/* Helpers */
const $ = id => document.getElementById(id);

function normalize(s){ return String(s || '').toLowerCase().trim(); }

/* Fetch & init */
async function init(){
  try {
    const res = await fetch(API);
    if(!res.ok) throw new Error('API error ' + res.status);
    const json = await res.json();
    halls = json.halls || [];
    hallBySlug = {};
    halls.forEach(h => hallBySlug[h.slug] = h);

    renderHallSelect();
    selectAllHalls();               // preserve behavior you said should not change
    attachControls();
    renderTable();
  } catch (err) {
    console.error(err);
    $('tableContainer').style.display='none';
    $('noResults').style.display='block';
    $('noResults').textContent = 'Error loading menus. Is backend running?';
  }
}

/* Render hall select (value=slug, label=name) */
function renderHallSelect(){
  const sel = $('hallSelect');
  sel.innerHTML = '';
  // Add an "All Halls" placeholder option for clarity (users can still multi-select)
  const headerOpt = document.createElement('option');
  headerOpt.value = 'ALL_HALLS';
  headerOpt.textContent = '--- All Halls (or select specific halls) ---';
  headerOpt.disabled = true;
  sel.appendChild(headerOpt);

  halls.forEach(h => {
    const opt = document.createElement('option');
    opt.value = h.slug;
    opt.textContent = h.name;
    sel.appendChild(opt);
  });

  // ensure change handler updates selectedSlugs
  sel.addEventListener('change', () => {
    selectedSlugs = Array.from(sel.selectedOptions).map(o => o.value).filter(v => v !== 'ALL_HALLS');
    // if user deselects all, treat as "all halls"
    if(selectedSlugs.length === 0) selectAllHalls();
    renderTable();
  });
}

/* select all helper (keeps existing UI behavior) */
function selectAllHalls(){
  const sel = $('hallSelect');
  Array.from(sel.options).forEach(opt => opt.selected = (opt.value !== 'ALL_HALLS'));
  selectedSlugs = halls.map(h => h.slug);
  renderTable();
}

/* attach other control handlers */
function attachControls(){
  $('selectAllBtn').addEventListener('click', () => {
    selectAllHalls();
  });

  $('mealSelect').addEventListener('change', e => {
    selectedMeal = e.target.value;
    renderTable();
  });

  document.querySelectorAll('.diet-btn').forEach(b => {
    b.addEventListener('click', () => {
      const d = b.dataset.diet;
      if(activeDiets.has(d)){
        activeDiets.delete(d);
        b.classList.remove('active');
      } else {
        activeDiets.add(d);
        b.classList.add('active');
      }
      renderTable();
    });
  });

  $('clearFilters').addEventListener('click', () => {
    activeDiets.clear();
    document.querySelectorAll('.diet-btn').forEach(b => b.classList.remove('active'));
    selectAllHalls();
    $('mealSelect').value = 'lunch';
    selectedMeal = 'lunch';
    renderTable();
  });
}

/* Determine whether a dish matches the active diets.
   - Prefer explicit dish.dietTags if present
   - Otherwise fall back to name / station / allergens keyword check
*/
function dishMatchesDiets(dish){
  if(activeDiets.size === 0) return true; // no filter -> everything allowed

  const tags = (dish.dietTags || []).map(t => normalize(t));
  const name = normalize(dish.name || '');
  const station = normalize(dish.station || '');
  const allergens = (dish.allergens || []).map(a => normalize(a)).join(' ');

  for(const diet of activeDiets){
    // check explicit tag
    if(tags.includes(diet)) continue;

    // check allergens if it explicitly says "contains gluten" etc. (conservative)
    if(allergens.includes(diet)) continue;

    // check name/station keywords
    const kws = dietKeywords[diet] || [];
    const matchByKeyword = kws.some(kw => name.includes(kw) || station.includes(kw));
    if(matchByKeyword) continue;

    // if none matched, dish does NOT satisfy this diet
    return false;
  }
  // passed all active diets
  return true;
}

/* Render table with ONLY hall columns (no 'Dish' first column).
   Each cell contains a vertical list of dishes for that hall that match filters.
*/
function renderTable(){
  const container = $('tableContainer');
  const headerRow = $('headerRow');
  const bodyRows = $('bodyRows');

  headerRow.innerHTML = '';
  bodyRows.innerHTML = '';

  // Determine halls to show (if none selected, show all)
  const showSlugs = selectedSlugs.length ? selectedSlugs : halls.map(h => h.slug);
  const showHalls = showSlugs.map(s => hallBySlug[s]).filter(Boolean);

  if(showHalls.length === 0){
    container.style.display = 'none';
    $('noResults').style.display = 'block';
    $('noResults').textContent = 'No halls selected.';
    return;
  }

  // Build header: just hall names (no dish column)
  showHalls.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h.name;
    headerRow.appendChild(th);
  });

  // For simplicity show a single-row table where each column contains the list for that hall.
  // Create one row only.
  const tr = document.createElement('tr');

  // For each hall, build a UL of filtered dishes (selectedMeal)
  let anyMatchesOverall = false;

  showHalls.forEach(h => {
    const td = document.createElement('td');
    const day = (h.days && h.days[0]) || {};
    const mealList = (day.meals && day.meals[selectedMeal]) || [];

    // Filter unknown names, trim
    const cleaned = mealList
      .filter(d => d && d.name && !/^unknown/i.test(d.name))
      .map(d => ({
        name: (d.name || '').trim(),
        dietTags: d.dietTags || [],
        station: d.station || '',
        allergens: d.allergens || [],
        raw: d
      }));

    // Apply diet filter to each dish for this hall
    const matches = cleaned.filter(d => dishMatchesDiets(d.raw));

    if(matches.length > 0) anyMatchesOverall = true;

    // Build UI: show matches. If none, show a hyphen or "(no matching dishes)"
    if(matches.length === 0){
      td.innerHTML = '<div style="color:#6b7280;font-style:italic">No matching dishes</div>';
    } else {
      const ul = document.createElement('ul');
      ul.className = 'dish-list';
      matches.forEach(m => {
        const li = document.createElement('li');
        // include tags if present
        const tagText = (m.dietTags || []).filter(Boolean).join(', ');
        li.innerHTML = `<div>${m.name}</div>${tagText ? `<div class="tags">${tagText}</div>` : ''}`;
        ul.appendChild(li);
      });
      td.appendChild(ul);
    }
    tr.appendChild(td);
  });

  bodyRows.appendChild(tr);

  // Show or hide containers depending on whether any hall had matches
  if(!anyMatchesOverall){
    container.style.display = 'none';
    $('noResults').style.display = 'block';
    $('noResults').textContent = 'No dishes match your filters across selected halls.';
  } else {
    container.style.display = '';
    $('noResults').style.display = 'none';
  }
}

/* Start */
init();
</script>
</body>
</html>
